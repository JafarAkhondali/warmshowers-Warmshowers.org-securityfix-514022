<?php
/**
 * @file
 * Site helpers for warmshowers.org
 *
 */



// Alter the user-to-user contact form to (by default) copy the sender
function warmshowers_site_form_contact_mail_user_alter(&$form, $form_state) {
  $form['copy']['#default_value'] = TRUE;
}

// Alter outgoing email to add information about who it is from, etc.
function warmshowers_site_mail_alter(&$message) {
  if ($message['id'] == 'contact_user_mail') {
    $recipient = $message['params']['recipient'];
    $sender = $message['params']['user'];
    $base_url = $GLOBALS['base_url'];
    $langcode = $recipient->language;

    // Note that here we're assuming that the body is an array, as it ought to
    // be. However, htmlmail makes it a string, and if htmlmail processes first,
    // this causes fatal errors. So we'll skip over this for that case.
    if (is_array($message['body'])) {
      foreach ($message['body'] as &$item) {
        $item = check_markup($item, FILTER_FORMAT_DEFAULT);
      }
      $message['body'][] = "-----------";
      $message['body'][] = t("This email was sent from user <a href='!sender_url'>!sender</a> to user <a href='!recipient_url'>!recipient</a>. You can just reply to it and the sender will receive your email.",
        array('!sender' => $sender->name, '!sender_email' => $sender->mail, '!recipient' => $recipient->name, '!recipient_email' => $recipient->mail, '!sender_url' => "$base_url/user/{$sender->uid}", '!recipient_url' => "$base_url/user/{$recipient->uid}"), $langcode);
    }
    else {
      $message['body'] = check_markup($message['body'], FILTER_FORMAT_DEFAULT);
    }
  }
}

/**
 * Alter user profile form.
 * @param $form
 * @param $form_state
 */
function warmshowers_site_form_user_profile_form_alter(&$form, &$form_state) {
  // On submit of user form, go to view instead of staying on edit.
  if (empty($form['submit']['#submit'])) {
    $form['submit']['#submit'] = $form['#submit'];
  }

  // Hide the comment_notify user-page settings, and make the default be
  // always send updates.
  $form['comment_notify_settings']['#access'] = FALSE;
  $form['comment_notify_settings']['node_notify_mailalert']['#type'] = 'value';
  $form['comment_notify_settings']['node_notify_mailalert']['#value'] = TRUE;

  $form['comment_notify_settings']['comment_notify_mailalert']['#type'] = 'value';
  $form['comment_notify_settings']['comment_notify_mailalert']['#value'] = TRUE;

}


/**
 * Implement hook_form_alter() to change the crazy handling in user_delete module.
 * We don't want people to have any choice but to delete it all.
 */
function warmshowers_site_form_alter(&$form, &$form_state, $form_id) {
  switch($form_id) {
    case 'user_confirm_delete':
      $form['user_delete_action'] = array(
      '#type' => 'value',
      '#value' => 'user_delete_delete',
      );
      $form['actions']['submit']['#value'] = t('Delete user account "@account"', array('@account' => $form['_account']['#value']->name));
      $form['description']['#value'] = t('The user account %account and all comments or other content associated with it will be deleted.', array('%account' => $form['_account']['#value']->name));
      break;

    // Use a translatable name for button instead of just "Delete".
    case 'user_profile_form':
      if (!empty($form['delete'])) {
        $form['delete']['#value'] = t("Delete Account");
      }
      break;

    // Get rid of the input filter stuff on comment.
    // Also change comment notification default values.
    case 'comment_form':
      $form['comment_filter']['format']['#access'] = FALSE;

      $form['notify_settings']['notify']['#default_value'] = TRUE;
      $form['notify_settings']['notify_type']['#default_value'] = 2;

      break;
  }
}
